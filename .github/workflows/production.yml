name: Builds

on:
  push:
    tags-ignore:
      - '*-classic'
    
  workflow_dispatch:

jobs:
    windows-x64:
      name: ü™ü Windows X64
      runs-on: [self-hosted, linux, X64]
      env:
          MOZCONFIG: ".mozconfig-x86_64-w64-mingw32"
          SHELL: /bin/sh
      steps:
        # All the commented out parts are only needed when setting up on a VM that gets destroyed
        # after each build. Since we are using a self hosted runner, this isn't necessary and affords
        # us performance wins.
        # - name: Cache
        #   uses: actions/cache@v2
        #   with:
        #     path: |
        #       $HOME/tooltool12
        #     key: ${{ runner.os }}-${{ hashFiles('**/browser/config/version_display.txt') }}

        # - name: Download tooltool
        #   run: |
        #     curl -O https://cdn.waterfox.net/tools/tooltool12.tar.xz
        #   if: steps.cache.outputs.cache-hit != 'true'

        # - name: Setup tooltool
        #   run: |
        #     tar -xvf tooltool12.tar.xz -C $HOME/
        #   if: steps.cache.outputs.cache-hit != 'true'

        # - name: Setup Rust
        #     run: |
        #       curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        #       rustup target add x86_64-pc-windows-gnu x86_64-pc-windows-msvc
        #       source $HOME/.cargo/env

        # - name: Setup Wine Env
        #       run: |
        #         Xvfb :2 -screen 0 1024x768x16 &


        - name: üì§ Checkout
          uses: actions/checkout@v2

        # - name: Bootstrap
        #   run: |
        #     ./mach --no-interactive bootstrap --application-choice=browser
        #     Xvfb :2 -screen 0 1024x768x16 &
        #     DISPLAY=:2

        - name: üèó Build
          run: |
            ./mach create-mach-environment
            ./mach build

        - name: üì¶ Package
          run: |
            ./mach package

        - name: üì¶ Package Multi-locale
          run: |
            ./mach package-multi-locale --locales en-US en-GB zh-CN zh-TW ja ko ru fr es-ES es-MX pt-PT pt-BR de pl nl da nn-NO sv-SE el it cs hu lt th id vi ar

        - name: ‚úçÔ∏è Sign
          run: |
            VERSION_DISPLAY=`cat browser/config/version_display.txt`
            pushd obj-x86_64-w64-mingw32/dist/install/sea/
            7z x waterfox-$VERSION_DISPLAY.en-US.win64.installer.exe
            rm -f waterfox-$VERSION_DISPLAY.en-US.win64.installer.exe
            az login --service-principal --username ${{ secrets.AZURE_USER_ID }} --password ${{ secrets.AZURE_USER_PWD }} --tenant ${{ secrets.AZURE_TENANT_ID }}
            find ./ -type f -name "*.exe" -exec jsign --storetype AZUREKEYVAULT --keystore ${{ secrets.AZURE_VAULT_ID }} --alias ${{ secrets.AZURE_CRT }} --tsaurl "http://rfc3161timestamp.globalsign.com/advanced" --tsmode RFC3161 --alg SHA-256 --storepass "$(az account get-access-token --resource "https://vault.azure.net" --tenant ${{ secrets.AZURE_TENANT_ID }} | jq -r .accessToken)" {} \;
            find ./ -type f -name "*.dll" -exec jsign --storetype AZUREKEYVAULT --keystore ${{ secrets.AZURE_VAULT_ID }} --alias ${{ secrets.AZURE_CRT }} --tsaurl "http://rfc3161timestamp.globalsign.com/advanced" --tsmode RFC3161 --alg SHA-256 --storepass "$(az account get-access-token --resource "https://vault.azure.net" --tenant ${{ secrets.AZURE_TENANT_ID }} | jq -r .accessToken)" {} \;
            7z a -r -t7z app.7z -mx -m0=BCJ2 -m1=LZMA:d25 -m2=LZMA:d19 -m3=LZMA:d19 -mb0:1 -mb0s1:2 -mb0s2:3
            cp $GITHUB_WORKSPACE/browser/installer/windows/app.tag .
            cp $GITHUB_WORKSPACE/other-licenses/7zstub/firefox/7zSD.Win32.sfx .
            cat 7zSD.Win32.sfx app.tag app.7z > "Waterfox $VERSION_DISPLAY Setup.exe"
            jsign --storetype AZUREKEYVAULT --keystore ${{ secrets.AZURE_VAULT_ID }} --alias ${{ secrets.AZURE_CRT }} --tsaurl "http://rfc3161timestamp.globalsign.com/advanced" --tsmode RFC3161 --alg SHA-256 --storepass "$(az account get-access-token --resource "https://vault.azure.net" --tenant ${{ secrets.AZURE_TENANT_ID }} | jq -r .accessToken)" "Waterfox $VERSION_DISPLAY Setup.exe"
            jsign -s $HOME/tooltool12/dummy.pfx --storepass=password --storetype=PKCS12 "Waterfox $VERSION_DISPLAY Setup.exe"
            az logout
            rm -rf core 7zSD.Win32.sfx app.tag app.7z setup.exe
            popd

        - name: üéÅ Update Package
          run: |
            VERSION_DISPLAY=`cat browser/config/version_display.txt`
            pushd obj-x86_64-w64-mingw32/dist/
            mkdir -p update
            cp $GITHUB_WORKSPACE/tools/update-packaging/make_full_update.sh update/
            cp $GITHUB_WORKSPACE/tools/update-packaging/common.sh update/
            cp -r "install/sea/Waterfox $VERSION_DISPLAY Setup.exe" update/
            xml=('<?xml version="1.0"?>'
            '<updates>'
            '    <update type="major" appVersion="VERSION"  buildID="BUILDID" detailsURL="https://www.waterfox.net/blog/waterfox-BROWSER_VERSION-release" displayVersion="BROWSER_VERSION">'
            '        <patch type="complete" URL="https://cdn.waterfox.net/releases/win64/update/waterfox-BROWSER_VERSION.en-US.win64.complete.xz.mar" hashFunction="SHA512" hashValue="HASH" size="SIZE"/>'
            '    </update>'
            '</updates>')
            for line in "${xml[@]}" ; do echo $line >> update/update.xml ; done
            pushd update
            7z x "Waterfox $VERSION_DISPLAY Setup.exe" -otmp/
            MAR=$HOME/tooltool12/mar \
                MOZ_PRODUCT_VERSION=$VERSION_DISPLAY MAR_CHANNEL_ID="default" \
                ./make_full_update.sh \
                waterfox-$VERSION_DISPLAY.en-US.win64.complete.xz.mar \
                'tmp/core'
            VERSION=$(grep '\<Version\>' tmp/core/application.ini | cut -d'=' -f2)
            BUILDID=$(grep 'BuildID=' tmp/core/application.ini | cut -d'=' -f2)
            SHA512=$(shasum -a 512 waterfox-$VERSION_DISPLAY.en-US.win64.complete.xz.mar | awk '{print $1}')
            SIZE=$(ls -l waterfox-$VERSION_DISPLAY.en-US.win64.complete.xz.mar | awk '{print $5}')
            echo "Display Version: $VERSION_DISPLAY, Version: $VERSION, Build ID: $BUILDID, File Size: $SIZE, SHA512: $SHA512"
            sed -i "s/OPERATING_SYSTEM/$OPERATING_SYSTEM/g" update.xml
            sed -i "s/BROWSER_VERSION/$VERSION_DISPLAY/g" update.xml
            sed -i "s/VERSION/$VERSION/g" update.xml
            sed -i "s/BUILDID/$BUILDID/g" update.xml
            sed -i "s/SIZE/$SIZE/g" update.xml
            sed -i "s/HASH/"$SHA512"/g" update.xml
            popd
            popd


        - name: üÜô Upload artifact
          uses: actions/upload-artifact@v2
          with:
            name: Waterfox Windows Artifact ${{ github.run_id }}
            path: |
              ./objdir-*/dist/install/sea/*.exe
              ./objdir-*/dist/update/*.mar
              ./objdir-*/dist/update/update.xml

        - name: Upload to CDN
          run: |
            rsync -e ssh ./objdir-*/dist/install/sea/*.exe ${{ secrets.FTP_USER }}@${{ secrets.FTP_HOST }}:/92790/waterfox/releases/win64/installer
            rsync -e ssh ./objdir-*/dist/update/*.mar ${{ secrets.FTP_USER }}@${{ secrets.FTP_HOST }}:/92790/waterfox/releases/win64/update

        - name: Upload new update.xml to test
          run: |
            aws s3 cp --content-type="text/xml" --metadata-directive="REPLACE" s3://aus.waterfox.net/update/test/WINNT/update.xml \
              s3://aus.waterfox.net/update/old/win64/latest/update.xml
            aws s3 cp --content-type="text/xml" --metadata-directive="REPLACE" ./objdir-*/dist/update/update.xml \
              s3://aus.waterfox.net/update/test/WINNT/update.xml

    linux-x64:
      name: üêß Linux X64
      runs-on: [self-hosted, linux, X64]
      env:
        shell: bash
        MOZCONFIG: ".mozconfig-x86_64-pc-linux-gnu"
      steps:
        - name: üì§ Checkout
          uses: actions/checkout@v2

        # - name: Bootstrap
        #   run: |
        #     ./mach --no-interactive bootstrap --application-choice=browser

        - name: üèó Build
          run: |
            ./mach build
            
        - name: üì¶ Package
          run: |
            ./mach package
            ./mach package-multi-locale --locales en-US en-GB zh-CN zh-TW ja ko ru fr es-ES es-MX pt-PT pt-BR de pl nl da nn-NO sv-SE el it cs hu lt th id vi ar
            mkdir update
            cp tools/update-packaging/make_full_update.sh update/
            cp tools/update-packaging/common.sh update/
            BROWSER_VERSION=`cat browser/config/version_display.txt`
            cp obj-x86_64-pc-linux-gnu/dist/waterfox-$BROWSER_VERSION.en-US.linux-x86_64.tar.bz2 update/
            xml=('<?xml version="1.0"?>'
            '<updates>'
            '    <update type="major" appVersion="VERSION"  buildID="BUILDID" detailsURL="https://www.waterfox.net/blog/waterfox-BROWSER_VERSION" displayVersion="BROWSER_VERSION">'
            '        <patch type="complete" URL="https://cdn.waterfox.net/releases/linux64/update/waterfox-BROWSER_VERSION.en-US.linux64.complete.xz.mar" hashFunction="SHA512" hashValue="HASH" size="SIZE"/>'
            '    </update>'
            '</updates>')

            for line in "${xml[@]}" ; do echo $line >> update/update.xml ; done
            cd update
            tar -xvf waterfox-$BROWSER_VERSION.en-US.linux-x86_64.tar.bz2
            MAR=../obj-x86_64-pc-linux-gnu/dist/host/bin/mar \
                MOZ_PRODUCT_VERSION=$BROWSER_VERSION MAR_CHANNEL_ID="default" \
                ./make_full_update.sh \
                waterfox-$BROWSER_VERSION.en-US.linux64.complete.xz.mar \
                'waterfox'
            VERSION=$(grep '\<Version\>' waterfox/application.ini | cut -d'=' -f2)
            BUILDID=$(grep 'BuildID=' waterfox/application.ini | cut -d'=' -f2)
            SHA512=$(shasum -a 512 waterfox-$BROWSER_VERSION.en-US.linux64.complete.xz.mar | awk '{print $1}')
                SIZE=$(ls -l waterfox-$BROWSER_VERSION.en-US.linux64.complete.xz.mar | awk '{print $5}')
            echo "Display Version: $BROWSER_VERSION, Version: $VERSION, Build ID: $BUILDID, File Size: $SIZE, SHA512: $SHA512"
            sed -i "s/OPERATING_SYSTEM/$OPERATING_SYSTEM/g" update.xml
            sed -i "s/BROWSER_VERSION/$BROWSER_VERSION/g" update.xml
            sed -i "s/VERSION/$VERSION/g" update.xml
            sed -i "s/BUILDID/$BUILDID/g" update.xml
            sed -i "s/SIZE/$SIZE/g" update.xml
            sed -i "s/HASH/"$SHA512"/g" update.xml
            
        - name: üÜô Upload artifact
          uses: actions/upload-artifact@v2
          with:
            name: Waterfox Linux Artifact ${{ github.run_id }}
            path: |
              ./objdir-*/dist/*.tar.bz2
              ./update/*.mar
              ./update/update.xml

        - name: Upload to CDN
          run: |
            rsync -e ssh ./objdir-*/dist/*.tar.bz2 ${{ secrets.FTP_USER }}@${{ secrets.FTP_HOST }}:/92790/waterfox/releases/linux64/installer
            rsync -e ssh ./update/*.mar ${{ secrets.FTP_USER }}@${{ secrets.FTP_HOST }}:/92790/waterfox/releases/linux64/update

        - name: Upload new update.xml to test
          run: |
            aws s3 cp --content-type="text/xml" --metadata-directive="REPLACE" s3://aus.waterfox.net/update/test/Linux/update.xml \
              s3://aus.waterfox.net/update/old/linux64/latest/update.xml
            aws s3 cp --content-type="text/xml" --metadata-directive="REPLACE" ./update/update.xml \
              s3://aus.waterfox.net/update/test/Linux/update.xml

    release:
      name: Release Windows & Linux
      needs: [windows-x64, linux-x64]
      runs-on: [self-hosted, linux, X64]
      env:
          SHELL: /bin/sh
      steps:
        - name: Push new update
          run: |
            os=(Windows_NT Linux)
            for i in ${os[@]}
            do
              update_loc='./update/update.xml'
              if [[ $i == 'Windows_NT' ]]
              then
                update_loc='./objdir-*/dist/update/update.xml'
              fi
              for j in $(aws s3 ls s3://aus.waterfox.net/update/Waterfox/ | awk '{OFS=" "};{if ($1=="PRE") print $2}')
              do
                if [[ $j != '/' ]]
                then
                ver=$(echo $j | sed 's/\///g')
                aws s3 cp --content-type="text/xml" --metadata-directive="REPLACE" $update_loc \
                  s3://aus.waterfox.net/update/Waterfox/$ver/aurora/$i/update.xml
                fi
              done
              VERSION=$(aws s3 cp s3://aus.waterfox.net/update/old/win64/latest/update.xml - | grep displayVersion | cut -d \" -f 10)
              aws s3 cp --content-type="text/xml" --metadata-directive="REPLACE" $update_loc \
                s3://aus.waterfox.net/update/Waterfox/$VERSION/aurora/$i/update.xml
            done

        - name: Bump website version
          run: |
            # Get the version number from version_display.txt
            cd $GITHUB_WORKSPACE
            BROWSER_VERSION=`cat browser/config/version_display.txt`
            # Checkout website repo if it doesn't exist
            cd ..
            if [ ! -d "website" ]
            then
              git checkout git@github.com:WaterfoxCo/website.git
            fi
            cd website
            # Push updated _config.yml
            NEW_VER="version_current: &ver2 '$BROWSER_VERSION'"
            sed -i "/^version_current/d" _config.yml
            sed -i "/^version_classic.*/a $NEW_VER" _config.yml
            git add _config.yml
            git commit -m "Bump current version to $BROWSER_VERSION."
            git push origin master
            # Do we create PR and the have a final step to merge the PR?

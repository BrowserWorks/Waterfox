name: 🔽 Pull Workflow

on:
  pull_request:
    branches: [current]

jobs:
  windows-x64:
    name: 🪟 Windows X64
    runs-on: [ubuntu-20.04]
    env:
      MOZCONFIG: ".mozconfig-x86_64-pc-windows-msvc"
      SHELL: /bin/sh
      WFX_RELEASE: 1
      WINEDEBUG: -all
      ARCH: x86_64-pc-mingw32
    steps:
      - name: 📤 Checkout
        uses: actions/checkout@v2

      - name: 🧰 Cache
        uses: actions/cache@v2
        id: cache-win-x64
        with:
          path: |
            ~/tooltool12
            ~/.cache/sccache
            ~/.mozbuild
          key: win-${{ hashFiles('**/browser/config/version_display.txt') }}
          restore-keys: |
            win-

      - name: 💿 Setup extra build dependencies
        run: |
          sudo apt update
          sudo apt install -y libpython3-dev uuid libasound2-dev libcurl4-openssl-dev libdbus-1-dev libdbus-glib-1-dev libdrm-dev libgtk-3-dev libpulse-dev libx11-xcb-dev libxt-dev nsis yasm nasm wget2
          wget2 https://www.7-zip.org/a/7z2102-linux-x64.tar.xz
          tar xf 7z2102-linux-x64.tar.xz
          sudo mv 7zz /usr/local/bin/7z

      - name: 💿 Setup rust
        run: |
          rustup target add x86_64-pc-windows-msvc

      - name: ⏬ Download tooltool
        run: |
          wget2 https://cdn.waterfox.net/tools/tooltool12.tar.xz
        if: steps.cache-win-x64.outputs.cache-hit != 'true'

      - name: 💿 Setup tooltool
        run: |
          tar -xvf tooltool12.tar.xz -C $HOME/
        if: steps.cache-win-x64.outputs.cache-hit != 'true'

      - name: 🍷 WINE environment
        run: |
              Xvfb :2 -screen 0 1024x768x16 &
              export DISPLAY=:2

      - name: 🏗 Build
        run: |
          sudo mount -t vfat $HOME/tooltool12/fat.fs /mnt/ -o rw,umask=0000 || :
          ./mach create-mach-environment
          ./mach build

      - name: 📦 Package
        run: |
          ./mach package
          ./mach package-multi-locale --locales ar cs da de el en-GB en-US es-ES es-MX fr hu id it ja ko lt nl nn-NO pl pt-BR pt-PT ru sv-SE th vi zh-CN zh-TW

  macos-x64:
    name: 🍎 macOS X64
    runs-on: [ubuntu-20.04]
    env:
      shell: bash
      MOZCONFIG: ".mozconfig-x86_64-apple-darwin"
      WFX_RELEASE: 1
      ARCH: x86_64-apple-darwin
    steps:
      - name: 📤 Checkout
        uses: actions/checkout@v2

      - name: 🧰 Cache restoration
        uses: actions/cache@v2
        id: cache-macos-x64
        with:
          path: |
            ~/crosstool12
            ~/.cache/sccache
          key: macos-x64-${{ hashFiles('**/browser/config/version_display.txt') }}
          restore-keys: |
            macos-x64-

      - name: 💿 Build dependencies installation
        run: |
          rustup target add ${{ env.ARCH }}
          sudo apt install nasm yasm wget2
          wget2 https://www.7-zip.org/a/7z2102-linux-x64.tar.xz
          tar xf 7z2102-linux-x64.tar.xz
          sudo mv 7zz /usr/local/bin/7z

      - name: ⏬ Download crosstool
        run: |
          wget2 https://cdn.waterfox.net/tools/crosstool12.tar.xz
        if: steps.cache-macos-x64.outputs.cache-hit != 'true'

      - name: 💿 Setup crosstool
        run: |
          tar -xvf crosstool12.tar.xz -C $HOME/
        if: steps.cache-macos-x64.outputs.cache-hit != 'true'

      - name: 🏗 Build
        run: |
          ./mach create-mach-environment
          ./mach build

      - name: 📦 Package
        run: |
          ./mach package
          ./mach package-multi-locale --locales ar cs da de el en-GB en-US es-ES es-MX fr hu id it ja ko lt nl nn-NO pl pt-BR pt-PT ru sv-SE th vi zh-CN zh-TW

  macos-arm64:
    name: 🍎 macOS ARM64
    runs-on: [ubuntu-20.04]
    env:
      shell: bash
      MOZCONFIG: ".mozconfig-aarch64-apple-darwin"
      WFX_RELEASE: 1
      ARCH: aarch64-apple-darwin
    steps:
      - name: 📤 Checkout
        uses: actions/checkout@v2

      - name: 🧰 Cache restoration
        uses: actions/cache@v2
        id: cache-macos-arm64
        with:
          path: |
            ~/crosstool12
            ~/.cache/sccache
          key: macos-arm64-${{ hashFiles('**/browser/config/version_display.txt') }}
          restore-keys: |
            macos-arm64-

      - name: 💿 Build dependencies installation
        run: |
          rustup target add ${{ env.ARCH }}
          sudo apt install wget2
          wget2 https://www.7-zip.org/a/7z2102-linux-x64.tar.xz
          tar xf 7z2102-linux-x64.tar.xz
          sudo mv 7zz /usr/local/bin/7z

      - name: ⏬ Download crosstool
        run: |
          wget2 https://cdn.waterfox.net/tools/crosstool12.tar.xz
        if: steps.cache-macos-arm64.outputs.cache-hit != 'true'

      - name: 💿 Setup crosstool
        run: |
          tar -xvf crosstool12.tar.xz -C $HOME/
        if: steps.cache-macos-arm64.outputs.cache-hit != 'true'

      - name: 🏗 Build
        run: |
          ./mach create-mach-environment
          ./mach build

      - name: 📦 Package
        run: |
          ./mach package
          ./mach package-multi-locale --locales ar cs da de el en-GB en-US es-ES es-MX fr hu id it ja ko lt nl nn-NO pl pt-BR pt-PT ru sv-SE th vi zh-CN zh-TW

  linux-x64:
    name: 🐧 Linux X64
    runs-on: [ubuntu-20.04]
    env:
      shell: bash
      MOZCONFIG: ".mozconfig-x86_64-pc-linux-gnu"
      WFX_RELEASE: 1
      ARCH: x86_64-pc-linux-gnu
    steps:
      - name: 📤 Checkout
        uses: actions/checkout@v2

      - name: 🧰 Cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/sccache
            ~/.mozbuild
          key: linux-${{ hashFiles('**/browser/config/version_display.txt') }}
          restore-keys: |
            linux-

      - name: 💿 Setup build packages
        run: |
          sudo apt update
          sudo apt install -y libpython3-dev uuid libasound2-dev libcurl4-openssl-dev libdbus-1-dev libdbus-glib-1-dev libdrm-dev libgtk-3-dev libpulse-dev libx11-xcb-dev libxt-dev nsis yasm nasm wget2
          sudo update-alternatives --remove-all clang
          sudo update-alternatives --remove-all clang++
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-12 100
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-12 100
          wget2 https://www.7-zip.org/a/7z2102-linux-x64.tar.xz
          tar xf 7z2102-linux-x64.tar.xz
          sudo mv 7zz /usr/local/bin/7z

      - name: 🏗 Build
        run: |
          ./mach create-mach-environment
          ./mach build

      - name: 📦 Package
        run: |
          ./mach package
          ./mach package-multi-locale --locales ar cs da de el en-GB en-US es-ES es-MX fr hu id it ja ko lt nl nn-NO pl pt-BR pt-PT ru sv-SE th vi zh-CN zh-TW
          